name: Publish

on:
  release:
    types:
      - published

jobs:
  build:
    name: Build distributions
    if: startsWith(github.event.release.tag_name, 'v') && github.event.release.prerelease == false
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout release tag
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          ref: ${{ github.event.release.tag_name }}

      - name: Install uv
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Install project Python
        run: uv python install "$(cat .python-version)"

      - name: Verify release tag matches pyproject version
        env:
          RELEASE_TAG: ${{ github.event.release.tag_name }}
        run: |
          python - <<'PY'
          import os
          import pathlib
          import tomllib

          pyproject = tomllib.loads(pathlib.Path("pyproject.toml").read_text())
          version = pyproject["project"]["version"]
          release_tag = os.environ["RELEASE_TAG"]
          tag_version = release_tag.removeprefix("v")

          if version != tag_version:
              raise SystemExit(
                  f"Release tag {release_tag} does not match pyproject version {version}"
              )

          print(f"Publishing version {version}")
          PY

      - name: Build wheel and sdist
        run: uv build --no-sources --sdist --wheel

      - name: Validate distribution metadata
        run: uvx twine check --strict dist/*

      - name: Smoke test wheel
        run: uv run --isolated --no-project --with dist/*.whl python -m town_elder --help

      - name: Smoke test source distribution
        run: uv run --isolated --no-project --with dist/*.tar.gz python -m town_elder --help

      - name: Upload distributions
        uses: actions/upload-artifact@v5
        with:
          name: python-package-distributions
          path: dist/*
          if-no-files-found: error

  publish-to-pypi:
    name: Publish to PyPI
    if: startsWith(github.event.release.tag_name, 'v') && github.event.release.prerelease == false
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: https://pypi.org/project/town-elder/
    permissions:
      attestations: write
      contents: read
      id-token: write
    steps:
      - name: Download distributions
        uses: actions/download-artifact@v6
        with:
          name: python-package-distributions
          path: dist/

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Generate artifact attestations
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: "dist/*"

      - name: Publish distributions to PyPI
        run: uv publish --trusted-publishing always --check-url https://pypi.org/simple/ dist/*
